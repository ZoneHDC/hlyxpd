// GENERATED BY UNITY. REMOVE THIS COMMENT TO PREVENT OVERWRITING WHEN EXPORTING AGAIN

buildscript {
    repositories {
        google()
        jcenter()
    }

    dependencies {
        classpath 'com.android.tools.build:gradle:3.2.0'
    }
}

allprojects {
    repositories {
        google()
        jcenter()
        flatDir {
            dirs 'libs'
        }
    }
}

apply plugin: 'com.android.application'


dependencies {
    implementation fileTree(dir: 'libs', include: ['*.jar'])
    implementation 'androidx.constraintlayout:constraintlayout:1.1.3'
    testImplementation 'junit:junit:4.12'
    androidTestImplementation 'androidx.test:runner:1.2.0'
    androidTestImplementation 'androidx.test.espresso:espresso-core:3.2.0'
//    compileOnly files('unity-classes.jar')
    //TTsdk
    implementation files('libs/glide-3.6.0.jar')
    implementation(name: 'open_ad_sdk', ext: 'aar')
    implementation(name: 'android-gif-drawable-1.2.6', ext: 'aar')
    implementation(name: 'circleimageview-2.2.0', ext: 'aar')
    implementation(name: 'LayoutManagerGroup', ext: 'aar')
    implementation(name: 'hellodaemon-1.2.2', ext: 'aar')
    implementation 'com.squareup.okhttp3:okhttp:4.0.1'

    //network 包
    implementation 'com.squareup.retrofit2:retrofit:2.5.0'
    implementation 'com.squareup.retrofit2:converter-gson:2.5.0'

}

import groovy.json.JsonSlurper
//读取配置
def getConfigs() {
    def inputFile = new File("${rootProject.projectDir.path}/channel/config.json").getText("utf-8")
    def json = new JsonSlurper().parseText(inputFile)
    return json
}

android {
    compileSdkVersion 28
    buildToolsVersion '28.0.3'

    compileOptions {
        sourceCompatibility JavaVersion.VERSION_1_8
        targetCompatibility JavaVersion.VERSION_1_8
    }

    defaultConfig {
        minSdkVersion 23
        targetSdkVersion 28
        applicationId 'com.changwan.hlyxpd.sw'
        ndk {
            abiFilters 'armeabi-v7a'
        }
        versionCode 2
        versionName '1.1'
        flavorDimensions "pack"
    }

    lintOptions {
        abortOnError false
    }

    aaptOptions {
        noCompress = ['.unity3d', '.ress', '.resource', '.obb']
        ignoreAssetsPattern = "!.svn:!.git:!.ds_store:!*.scc:.*:!CVS:!thumbs.db:!picasa.ini:!*~"
    }

    packagingOptions {
        exclude 'META-INF/proguard/androidx-annotations.pro'
    }

    //打包配置
    productFlavors {
//        chuizi {
//            applicationId "com.changwan.bksjdzz.cz"
//            buildConfigField("boolean", "SDK_DEBUG", "false")
//            dimension "pack"
//            //要保证res/value/string.xml中没有app_name，如果有务必删除
//            resValue "string", "app_name", "模拟球球大作战"
//        }
//
//        shunwan {
//            applicationId "com.changwan.bksjdzz.sw"
//            buildConfigField("boolean", "SDK_DEBUG", "false")
//            dimension "pack"
//            //要保证res/value/string.xml中没有app_name，如果有务必删除
//            resValue "string", "app_name", "模拟球球大作战"
//        }
        //读取json
        def json = getConfigs()
        //遍历渠道json
        json.each {
            flavor ->
                //判断是否打包
                if (flavor.is_pack) {
                    "${flavor.name}" {
                        dimension "pack"
                        applicationId "${flavor.package_name}"
                        buildConfigField("boolean", "SDK_DEBUG", "${flavor.sdk_debug}")
                        resValue "string", "app_name", "${flavor.app_name}"
                    }
                }
        }
    }

    signingConfigs {
        debug {
            storeFile
            storePassword
            keyAlias
            keyPassword
            v1SigningEnabled true
            v2SigningEnabled false
        }

        release {
            storeFile
            storePassword
            keyAlias
            keyPassword
            v1SigningEnabled true
            v2SigningEnabled false
        }
    }

    getSigningProperties()

    applicationVariants.all { variant ->
        variant.outputs.all {
            def fileName = "hlyxpd_${defaultConfig.versionName}_${variant.productFlavors[0].name}.apk"
            outputFileName = fileName
        }
    }

    buildTypes {
        release {
            minifyEnabled false
            signingConfig signingConfigs.release
            useProguard false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-unity.pro'
        }

        debug {
            minifyEnabled false
            useProguard false
            jniDebuggable true
            proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-unity.txt'
            signingConfig signingConfigs.release

        }

        applicationVariants.all {
            //判断是release还是debug版本
            def buildType = it.buildType.name
            //获取当前时间的"YYYY-MM-dd"格式。
            def createTime = new Date().format("YYYY-MM-dd", TimeZone.getTimeZone("GMT+08:00"))
            //如果是正式包,将其输入到指定文件夹
            if (buildType == "release") {
                it.getPackageApplication().outputDirectory = new File('packages'+ "/${it.productFlavors[0].applicationId}/${createTime}")
            }
        }
    }

    project.afterEvaluate {
        getProductFlavors().each { f ->
            println("我的名渠道号是：${f.name}")
            task "${f.name}"(type: Copy, group: "custom", description: "拷贝资源文件") {
                from "${rootProject.projectDir.path}/channel/${f.name}/wlini"
                into "src/main/assets/"
            }
            tasks.matching {
                it.name.startsWith('pre') && ((it.name.endsWith('ReleaseBuild')) || it.name.endsWith('DebugBuild'))
            }.each { t ->
                def what
                if (t.name.endsWith('DebugBuild')) {
                    what = t.name.substring(3, t.name.indexOf("Debug")).toLowerCase()
                } else {
                    what = t.name.substring(3, t.name.indexOf("Release")).toLowerCase()
                }
                t.dependsOn(what)
            }

        }
    }

    packagingOptions {
        doNotStrip '*/armeabi-v7a/*.so'
    }


    bundle {
        language {
            enableSplit = false
        }
        density {
            enableSplit = false
        }
        abi {
            enableSplit = true
        }
    }
}

def getSigningProperties() {

    def propFile = file('signing.properties')
    if (propFile.canRead()) {
        def Properties props = new Properties()
        props.load(new FileInputStream(propFile))
        if (props != null && props.containsKey('STORE_FILE') && props.containsKey('STORE_PASSWORD') &&
                props.containsKey('KEY_ALIAS') && props.containsKey('KEY_PASSWORD')) {

            android.signingConfigs.release.storeFile = file(props['STORE_FILE'])
            android.signingConfigs.release.storePassword = props['STORE_PASSWORD']
            android.signingConfigs.release.keyAlias = props['KEY_ALIAS']
            android.signingConfigs.release.keyPassword = props['KEY_PASSWORD']

            android.signingConfigs.debug.storeFile = file(props['STORE_FILE'])
            android.signingConfigs.debug.storePassword = props['STORE_PASSWORD']
            android.signingConfigs.debug.keyAlias = props['KEY_ALIAS']
            android.signingConfigs.debug.keyPassword = props['KEY_PASSWORD']

        } else {

            println 'signing.properties found but some entries are missing'
            android.buildTypes.release.signingConfig = null
        }
    } else {
        println 'signing.properties not found'
        android.buildTypes.release.signingConfig = null
    }
}

task copyFile(type: Copy, group: "custom", description: "拷贝资源文件") {
    from "${rootProject.projectDir.path}/channel/baidu/wlini"
    into "src/main/assets/wlini"
}
//下面为编译时的操作
tasks.matching {
    it.name.startsWith('pre') && ((it.name.endsWith('ReleaseBuild')) || it.name.endsWith('DebugBuild'))
}.each { t ->
    def what
    if (t.name.endsWith('DebugBuild')) {
        what = t.name.substring(3, t.name.indexOf("Debug")).toLowerCase()
    } else {
        what = t.name.substring(3, t.name.indexOf("Release")).toLowerCase()
    }
    t.dependsOn(what)
}
